# OpenSearch MCP Agent

A custom [Model Context Protocol (MCP)](https://modelcontextprotocol.io/) server that lets [Claude Code](https://docs.anthropic.com/en/docs/claude-code) query OpenSearch clusters protected by OpenID Connect (Azure AD) authentication â€” without direct CLI access to the cluster.

## Problem

- OpenSearch clusters sit behind **OpenSearch Dashboards** with **OIDC / Azure AD** auth
- No direct CLI or API key access to the cluster
- The official [opensearch-mcp-server-py](https://github.com/opensearch-project/opensearch-mcp-server-py) doesn't support cookie/session-based OIDC auth

## How It Works

The MCP server makes direct HTTP calls to the same internal API endpoint (`/internal/search/opensearch-with-long-numerals`) that the Dashboards UI uses, authenticated with browser session cookies.

```
Claude Code â†’ MCP (stdio) â†’ server.py â†’ HTTP POST â†’ OpenSearch Dashboards APIs â†’ OpenSearch
```

There is no proxy or standalone OpenSearch server involved.

## Features

- **Cookie-based OIDC auth** â€” uses the same session cookies as the browser
- **Auto cookie refresh** â€” on 401, launches headless Playwright to re-authenticate via cached SSO session
- **Context optimization** â€” auto-prune, field filtering, summary-only mode, per-hit truncation, and 15KB response cap to keep Claude's context window lean
- **Response metadata** â€” every response includes `_meta.applied_operations` so Claude knows what was filtered/truncated
- **Multi-cluster support** â€” Support any number of clusters
- **Claude skill** â€” built-in skill teaching Claude cost-conscious query patterns

## Available Tools

| Tool | Description |
|------|-------------|
| `opensearch_search` | Search logs with Lucene/KQL query strings, time range, field filtering, summary mode |
| `opensearch_search_raw` | Search with raw OpenSearch Query DSL |
| `opensearch_aggregate` | Aggregation queries (counts, terms, histograms) |
| `opensearch_get_indices` | List indices with document counts |
| `opensearch_get_mappings` | Get field names and types from a sample document |
| `opensearch_cluster_health` | Basic cluster health info |

## Prerequisites

- Python 3.10+
- [Claude Code](https://docs.anthropic.com/en/docs/claude-code) CLI
- Access to an OpenSearch Dashboards instance with OIDC/Azure AD auth

## Quick Setup

**TL;DR:** Run the initialization script to set everything up automatically:

```bash
./init.sh
```

This script will:
- âœ“ Check Python version (requires 3.10+)
- âœ“ Create a virtual environment at `opensearch-mcp/venv/`
- âœ“ Install all dependencies (mcp, httpx, playwright)
- âœ“ Install Chromium browser (for cookie auto-refresh)
- âœ“ Generate `.mcp.json` with correct absolute paths
- âœ“ Verify the setup

### Manual Setup (if needed)

<details>
<summary>Click to expand manual setup steps</summary>

#### 1. Create virtual environment and install dependencies

```bash
cd opensearch-mcp
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

#### 2. Install Playwright (for cookie auto-refresh)

```bash
pip install playwright
playwright install chromium
```

#### 3. Update `.mcp.json` with correct paths

```json
{
  "mcpServers": {
    "opensearch": {
      "type": "stdio",
      "command": "/absolute/path/to/opensearch-mcp/venv/bin/python",
      "args": ["/absolute/path/to/opensearch-mcp/server.py"],
      "env": {
        "OPENSEARCH_URL": "https://your-opensearch-dashboard-url",
        "OPENSEARCH_VERIFY_SSL": "true"
      }
    }
  }
}
```

</details>

### Get Initial Cookies

After running `init.sh`, fetch cookies for your cluster:

```bash
cd opensearch-mcp

# List available clusters
./get-cookies.py --list

# Fetch cookies for a cluster (opens browser for SSO login)
./get-cookies.py prod-azure-us-cdp
```

This writes `cookies.json` which the server reads on every request.

### Start Claude Code

```bash
claude
```

Claude will automatically load the MCP server and have access to all OpenSearch tools.

## Usage Examples

Once set up, you can ask Claude things like:

- "Search for errors in the `my-namespace` namespace in the last hour"
- "How many logs were generated by pod `api-server-xyz` today?"
- "Show me logs containing request ID `77e71a17-2e52-404a-86d2-eed997fd2a57`"
- "What are the top 10 namespaces by log volume in the last 24 hours?"
- "Check cluster health"

Claude uses a cost-conscious query strategy: count first (`summary_only`), sample with field filtering, aggregate for analysis, and full fetch only when needed.

## Cookie Management

### Automatic refresh
When cookies expire (401), the server automatically:
1. Launches a headless Playwright browser
2. Uses the cached Azure AD SSO session to get fresh cookies
3. Saves to `cookies.json` and retries the request transparently

### Manual refresh
If the SSO session itself has expired:

```bash
cd opensearch-mcp
./get-cookies.py <cluster-short-name>
```

This opens a browser for interactive login. After login, cookies are saved â€” **no Claude Code restart needed**.

### Switching clusters

```bash
./get-cookies.py <cluster-short-name>
# Then restart Claude Code to pick up the new OPENSEARCH_URL
```

## Project Structure

```
opensearch-agent/
â”œâ”€â”€ init.sh                            # ðŸš€ Setup automation script (run this first!)
â”œâ”€â”€ .mcp.json                          # MCP server config (auto-generated, gitignored)
â”œâ”€â”€ .gitignore                         # Ignores venv/, cookies, logs, etc.
â”œâ”€â”€ README.md                          # This file
â”œâ”€â”€ CLAUDE.md                          # Detailed knowledge base & learnings
â”œâ”€â”€ .claude/
â”‚   â””â”€â”€ skills/
â”‚       â””â”€â”€ opensearch/
â”‚           â””â”€â”€ SKILL.md               # Claude skill for query patterns
â””â”€â”€ opensearch-mcp/
    â”œâ”€â”€ server.py                      # MCP server (cookie auth, auto-refresh, context optimization)
    â”œâ”€â”€ clusters.py                    # Shared cluster registry
    â”œâ”€â”€ get-cookies.py                 # Playwright-based cookie fetcher (multi-cluster SSO)
    â”œâ”€â”€ cookies.json                   # Auto-managed cookie store (gitignored)
    â”œâ”€â”€ server.log                     # Debug logs (gitignored)
    â”œâ”€â”€ requirements.txt               # Python dependencies
    â”œâ”€â”€ .browser-data/                 # Playwright persistent browser profile (gitignored)
    â””â”€â”€ venv/                          # Python virtual environment (gitignored)
```

## Context Optimization

The server optimizes responses to minimize Claude's context window usage:

| Feature | Description |
|---------|-------------|
| `summary_only` | Returns only hit count and time range (~100 tokens) |
| `auto_prune` | Strips `kubernetes.labels` and `kubernetes.annotations` (on by default) |
| `fields` | Return only specified fields (saves 70-80% context) |
| `max_chars_per_hit` | Truncates individual hits exceeding 2000 chars |
| Response cap | Overall response capped at 15KB |

## Dependencies

- [mcp](https://pypi.org/project/mcp/) >= 1.0.0 â€” Model Context Protocol SDK
- [httpx](https://pypi.org/project/httpx/) >= 0.27.0 â€” HTTP client
- [playwright](https://pypi.org/project/playwright/) â€” Browser automation for cookie refresh
