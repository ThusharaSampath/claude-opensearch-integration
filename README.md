# OpenSearch MCP Agent

A custom [Model Context Protocol (MCP)](https://modelcontextprotocol.io/) server that lets [Claude Code](https://docs.anthropic.com/en/docs/claude-code) query OpenSearch clusters protected by OpenID Connect (Azure AD) authentication — without direct CLI access to the cluster.

## Problem

- OpenSearch clusters sit behind **OpenSearch Dashboards** with **OIDC / Azure AD** auth
- No direct CLI or API key access to the cluster
- The official [opensearch-mcp-server-py](https://github.com/opensearch-project/opensearch-mcp-server-py) doesn't support cookie/session-based OIDC auth

## How It Works

The MCP server makes direct HTTP calls to the same internal API endpoint (`/internal/search/opensearch-with-long-numerals`) that the Dashboards UI uses, authenticated with browser session cookies.

```
Claude Code → MCP (stdio) → server.py → HTTP POST → OpenSearch Dashboards → OpenSearch
```

There is no proxy or standalone OpenSearch server involved.

## Features

- **Cookie-based OIDC auth** — uses the same session cookies as the browser
- **Auto cookie refresh** — on 401, launches headless Playwright to re-authenticate via cached SSO session
- **Context optimization** — auto-prune, field filtering, summary-only mode, per-hit truncation, and 15KB response cap to keep Claude's context window lean
- **Response metadata** — every response includes `_meta.applied_operations` so Claude knows what was filtered/truncated
- **Multi-cluster support** — 29 clusters across Dev, Staging, and Production environments
- **Claude skill** — built-in skill teaching Claude cost-conscious query patterns

## Available Tools

| Tool | Description |
|------|-------------|
| `opensearch_search` | Search logs with Lucene/KQL query strings, time range, field filtering, summary mode |
| `opensearch_search_raw` | Search with raw OpenSearch Query DSL |
| `opensearch_aggregate` | Aggregation queries (counts, terms, histograms) |
| `opensearch_get_indices` | List indices with document counts |
| `opensearch_get_mappings` | Get field names and types from a sample document |
| `opensearch_cluster_health` | Basic cluster health info |

## Prerequisites

- Python 3.10+
- [Claude Code](https://docs.anthropic.com/en/docs/claude-code) CLI
- Access to an OpenSearch Dashboards instance with OIDC/Azure AD auth

## Setup

### 1. Create virtual environment and install dependencies

```bash
cd opensearch-mcp-wrapper
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

### 2. Install Playwright (for cookie auto-refresh)

```bash
pip install playwright
playwright install chromium
```

### 3. Get initial cookies

```bash
# List available clusters
./get-cookies.py --list

# Fetch cookies for a cluster (opens browser for SSO login)
./get-cookies.py prod-azure-us-cdp
```

This writes `cookies.json` which the server reads on every request.

### 4. Configure Claude Code

The `.mcp.json` in the project root is already configured. Update the paths and `OPENSEARCH_URL` if needed:

```json
{
  "mcpServers": {
    "opensearch": {
      "type": "stdio",
      "command": "<path-to>/opensearch-mcp-wrapper/venv/bin/python",
      "args": ["<path-to>/opensearch-mcp-wrapper/server.py"],
      "env": {
        "OPENSEARCH_URL": "https://your-opensearch-dashboard-url",
        "OPENSEARCH_VERIFY_SSL": "true"
      }
    }
  }
}
```

### 5. Start Claude Code

```bash
cd opensearch-agent
claude
```

Claude will automatically load the MCP server and have access to all OpenSearch tools.

## Usage Examples

Once set up, you can ask Claude things like:

- "Search for errors in the `my-namespace` namespace in the last hour"
- "How many logs were generated by pod `api-server-xyz` today?"
- "Show me logs containing request ID `77e71a17-2e52-404a-86d2-eed997fd2a57`"
- "What are the top 10 namespaces by log volume in the last 24 hours?"
- "Check cluster health"

Claude uses a cost-conscious query strategy: count first (`summary_only`), sample with field filtering, aggregate for analysis, and full fetch only when needed.

## Cookie Management

### Automatic refresh
When cookies expire (401), the server automatically:
1. Launches a headless Playwright browser
2. Uses the cached Azure AD SSO session to get fresh cookies
3. Saves to `cookies.json` and retries the request transparently

### Manual refresh
If the SSO session itself has expired:

```bash
cd opensearch-mcp-wrapper
./get-cookies.py <cluster-short-name>
```

This opens a browser for interactive login. After login, cookies are saved — **no Claude Code restart needed**.

### Switching clusters

```bash
./get-cookies.py <cluster-short-name>
# Then restart Claude Code to pick up the new OPENSEARCH_URL
```

## Project Structure

```
opensearch-agent/
├── .mcp.json                          # MCP server config (project-scope)
├── .claude/
│   └── skills/
│       └── opensearch/
│           └── SKILL.md               # Claude skill for query patterns
├── KNOWLEDGE.md                       # Detailed knowledge base & learnings
├── README.md                          # This file
└── opensearch-mcp-wrapper/
    ├── server.py                      # MCP server (cookie auth, auto-refresh, context optimization)
    ├── get-cookies.py                 # Playwright-based cookie fetcher (multi-cluster SSO)
    ├── cookies.json                   # Auto-managed cookie store
    ├── requirements.txt               # Python dependencies
    ├── pyproject.toml                 # Project metadata
    ├── .browser-data/                 # Playwright persistent browser profile
    └── venv/                          # Python virtual environment
```

## Context Optimization

The server optimizes responses to minimize Claude's context window usage:

| Feature | Description |
|---------|-------------|
| `summary_only` | Returns only hit count and time range (~100 tokens) |
| `auto_prune` | Strips `kubernetes.labels` and `kubernetes.annotations` (on by default) |
| `fields` | Return only specified fields (saves 70-80% context) |
| `max_chars_per_hit` | Truncates individual hits exceeding 2000 chars |
| Response cap | Overall response capped at 15KB |

## Supported Clusters

29 clusters across Development, Staging, and Production. See [KNOWLEDGE.md](KNOWLEDGE.md#cluster-registry) for the full registry.

Common aliases:
- `prod` → `prod-azure-us-cdp`
- `dev` → `dev-azure-us-cdp`
- `stg` → `stg-azure-us-cdp`

## Dependencies

- [mcp](https://pypi.org/project/mcp/) >= 1.0.0 — Model Context Protocol SDK
- [httpx](https://pypi.org/project/httpx/) >= 0.27.0 — HTTP client
- [playwright](https://pypi.org/project/playwright/) — Browser automation for cookie refresh
